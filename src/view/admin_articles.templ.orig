package view

import (
	"alc/config"
	"alc/repository"
	"fmt"
	"path"
)

// formatPublishedAtRow formatea la fecha de publicación
func formatPublishedAtRow(article repository.ListAllArticlesRow) string {
	if !article.PublishedAt.Valid {
		return "-"
	}
	return article.PublishedAt.Time.Format("02/01/2006 15:04")
}

// formatCreatedAtRow formatea la fecha de creación
func formatCreatedAtRow(article repository.ListAllArticlesRow) string {
	if !article.CreatedAt.Valid {
		return "-"
	}
	return article.CreatedAt.Time.Format("02/01/2006 15:04")
}

// formatPublishedAtDetail formatea la fecha de publicación para detalle
func formatPublishedAtDetail(article repository.GetArticleRow) string {
	if !article.PublishedAt.Valid {
		return "-"
	}
	return article.PublishedAt.Time.Format("02/01/2006 15:04")
}

// formatCreatedAtDetail formatea la fecha de creación para detalle
func formatCreatedAtDetail(article repository.GetArticleRow) string {
	if !article.CreatedAt.Valid {
		return "-"
	}
	return article.CreatedAt.Time.Format("02/01/2006 15:04")
}

// AdminArticlesPage muestra la lista de artículos del blog
templ AdminArticlesPage(username string, articles []repository.ListAllArticlesRow, imagesMap map[int32]repository.StaticFile) {
	@AdminLayout("Artículos", username) {
		<div class="space-y-6">
			<div class="flex justify-between items-center">
				<h1 class="text-3xl font-bold">Gestión de Artículos</h1>
				<a href="/admin/articles/new" class="btn btn-primary">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
					</svg>
					Nuevo Artículo
				</a>
			</div>
			<!-- Articles Table -->
			<div class="overflow-x-auto bg-base-100 rounded-lg shadow">
				<table class="table table-zebra">
					<thead>
						<tr>
							<th>Portada</th>
							<th>Título</th>
							<th>Autor</th>
							<th>Estado</th>
							<th>Fecha</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="articles-list">
						if len(articles) == 0 {
							<tr>
								<td colspan="6" class="text-center text-base-content/60">
									No hay artículos registrados. Crea uno nuevo para comenzar.
								</td>
							</tr>
						} else {
							for _, article := range articles {
								@AdminArticleRow(article, imagesMap)
							}
						}
					</tbody>
				</table>
			</div>
		</div>
	}
}

// AdminArticleRow representa una fila de artículo en la tabla
templ AdminArticleRow(article repository.ListAllArticlesRow, imagesMap map[int32]repository.StaticFile) {
	<tr>
		<td>
			<div class="avatar">
				<div class="w-16 h-16 rounded">
					if article.CoverImageID.Valid {
						if img, ok := imagesMap[article.CoverImageID.Int32]; ok {
							<img src={ path.Join(config.IMAGES_PATH, img.FileName) } alt={ article.Title }/>
						} else {
							<img src="/static/img/placeholder.webp" alt="Sin imagen"/>
						}
					} else {
						<img src="/static/img/placeholder.webp" alt="Sin imagen"/>
					}
				</div>
			</div>
		</td>
		<td>
			<div class="font-bold">{ article.Title }</div>
			<div class="text-sm opacity-50">{ article.Slug }</div>
		</td>
		<td>{ article.Author }</td>
		<td>
			if article.IsPublished {
				<span class="badge badge-success">Publicado</span>
			} else {
				<span class="badge badge-warning">Borrador</span>
			}
		</td>
		<td>
			if article.IsPublished {
				<div class="text-sm">{ formatPublishedAtRow(article) }</div>
			} else {
				<div class="text-sm">{ formatCreatedAtRow(article) }</div>
			}
		</td>
		<td class="space-x-1">
			<a href={ templ.URL(fmt.Sprintf("/admin/articles/%d", article.ArticleID)) } class="btn btn-sm btn-info">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
				</svg>
			</a>
			<a href={ templ.URL(fmt.Sprintf("/admin/articles/%d/edit", article.ArticleID)) } class="btn btn-sm btn-warning">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
				</svg>
			</a>
			if article.IsPublished {
				<button
					hx-post={ fmt.Sprintf("/admin/articles/%d/unpublish", article.ArticleID) }
					hx-confirm="¿Despublicar este artículo?"
					hx-target="body"
					class="btn btn-sm btn-ghost"
					title="Despublicar"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
					</svg>
				</button>
			} else {
				<button
					hx-post={ fmt.Sprintf("/admin/articles/%d/publish", article.ArticleID) }
					hx-confirm="¿Publicar este artículo?"
					hx-target="body"
					class="btn btn-sm btn-success"
					title="Publicar"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
					</svg>
				</button>
			}
			<button
				hx-delete={ fmt.Sprintf("/admin/articles/%d", article.ArticleID) }
				hx-confirm="¿Estás seguro de eliminar este artículo? Esta acción eliminará también sus FAQs."
				hx-target="closest tr"
				hx-swap="outerHTML"
				class="btn btn-sm btn-error"
			>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
				</svg>
			</button>
		</td>
	</tr>
}

// AdminArticleFormPage muestra el formulario para crear/editar un artículo
templ AdminArticleFormPage(username string, article *repository.GetArticleRow, images []repository.StaticFile, isEdit bool) {
	@AdminBase(getArticleFormTitle(isEdit) + " - Admin") {
		<!-- Quill CSS -->
		<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet"/>
		<style>
			.ql-editor {
				min-height: 300px;
			}
		</style>
		<div class="drawer lg:drawer-open">
			<input id="admin-drawer" type="checkbox" class="drawer-toggle"/>
			<div class="drawer-content flex flex-col">
				<!-- Navbar -->
				<div class="w-full navbar bg-base-100 shadow-md">
					<div class="flex-none lg:hidden">
						<label for="admin-drawer" class="btn btn-square btn-ghost">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</label>
					</div>
					<div class="flex-1 px-2 mx-2">
						<span class="text-lg font-bold">Panel de Administración</span>
					</div>
				</div>
				<!-- Page content -->
				<div class="p-4 lg:p-8">
					<div class="space-y-6">
						<div class="flex items-center gap-4">
							<a href="/admin/articles" class="btn btn-ghost btn-sm">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
								</svg>
							</a>
							<h1 class="text-3xl font-bold">
								if isEdit {
									Editar Artículo
								} else {
									Nuevo Artículo
								}
							</h1>
						</div>
						<div class="card bg-base-100 shadow-xl">
							<div class="card-body">
								<form
									id="article-form"
									if isEdit && article != nil {
										hx-put={ fmt.Sprintf("/admin/articles/%d", article.ArticleID) }
									} else {
										hx-post="/admin/articles"
									}
									hx-target="body"
									class="space-y-4"
								>
									<!-- Título -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Título *</span>
										</label>
										<input
											type="text"
											name="title"
											id="title-input"
											class="input input-bordered"
											placeholder="El título del artículo"
											if isEdit && article != nil {
												value={ article.Title }
											}
											required
										/>
									</div>
									<!-- Slug -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Slug (URL) *</span>
											<span class="label-text-alt">Solo letras minúsculas, números y guiones</span>
										</label>
										<input
											type="text"
											name="slug"
											id="slug-input"
											class="input input-bordered"
											placeholder="el-titulo-del-articulo"
											pattern="[a-z0-9\-]+"
											if isEdit && article != nil {
												value={ article.Slug }
											}
											required
										/>
									</div>
									<!-- Autor -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Autor</span>
										</label>
										<input
											type="text"
											name="author"
											class="input input-bordered"
											placeholder="JR del Perú"
											if isEdit && article != nil {
												value={ article.Author }
											} else {
												value="JR del Perú"
											}
										/>
									</div>
									<!-- Resumen -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Resumen *</span>
											<span class="label-text-alt">Se usa como meta descripción para SEO</span>
										</label>
										<textarea
											name="summary"
											class="textarea textarea-bordered"
											rows="3"
											placeholder="Breve descripción del artículo (máx. 160 caracteres recomendado)"
											required
										>
											if isEdit && article != nil {
												{ article.Summary }
											}
										</textarea>
									</div>
									<!-- Imagen de portada -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Imagen de Portada</span>
										</label>
										<div class="flex gap-2 items-end">
											<select name="cover_image_id" id="cover_image_id" class="select select-bordered flex-1">
												<option value="">Sin imagen de portada</option>
												for _, img := range images {
													<option
														value={ fmt.Sprint(img.FileID) }
														if isEdit && article != nil && article.CoverImageID.Valid && article.CoverImageID.Int32 == img.FileID {
															selected
														}
													>
														if img.DisplayName.Valid && img.DisplayName.String != "" {
															{ img.DisplayName.String }
														} else {
															{ img.FileName }
														}
													</option>
												}
											</select>
											<button type="button" onclick="openImageUploadModal('cover_image_id')" class="btn btn-outline btn-primary">
												<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
												</svg>
												Subir
											</button>
										</div>
									</div>
									<!-- Contenido (Quill Editor) -->
									<div class="form-control">
										<label class="label">
											<span class="label-text font-semibold">Contenido *</span>
										</label>
										<div id="editor" class="bg-white rounded-lg border border-base-300"></div>
										<input type="hidden" name="content" id="content-input"/>
									</div>
									<!-- Botones -->
									<div class="flex gap-2 justify-end pt-4">
										<a href="/admin/articles" class="btn btn-ghost">Cancelar</a>
										<button type="submit" class="btn btn-primary">
											if isEdit {
												Guardar Cambios
											} else {
												Crear Artículo
											}
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
				@adminSidebarContent()
			</div>
		</div>
		<!-- Image Upload Modal -->
		@ImageUploadModal()
		<!-- Quill JS -->
		<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
		<script>
			// Initialize Quill editor
			var quill = new Quill('#editor', {
				theme: 'snow',
				modules: {
					toolbar: [
						[{ 'header': [1, 2, 3, false] }],
						['bold', 'italic', 'underline', 'strike'],
						[{ 'list': 'ordered'}, { 'list': 'bullet' }],
						[{ 'align': [] }],
						['link', 'image'],
						['blockquote', 'code-block'],
						['clean']
					]
				},
				placeholder: 'Escribe el contenido del artículo aquí...'
			});

			// Sync content to hidden input before form submit
			document.getElementById('article-form').addEventListener('submit', function(e) {
				document.getElementById('content-input').value = quill.root.innerHTML;
			});

			// Also sync on htmx before request
			document.body.addEventListener('htmx:configRequest', function(evt) {
				if (evt.detail.elt.id === 'article-form') {
					document.getElementById('content-input').value = quill.root.innerHTML;
				}
			});

			// Auto-generate slug from title
			var titleInput = document.getElementById('title-input');
			var slugInput = document.getElementById('slug-input');

			if (titleInput && slugInput) {
				titleInput.addEventListener('input', function() {
					if (!slugInput.dataset.manuallyEdited) {
						slugInput.value = generateSlug(this.value);
					}
				});

				slugInput.addEventListener('input', function() {
					slugInput.dataset.manuallyEdited = 'true';
				});

				slugInput.addEventListener('change', function() {
					if (this.value === '') {
						delete slugInput.dataset.manuallyEdited;
					}
				});
			}
		</script>
		if isEdit && article != nil {
			<script>
				// Load existing content in edit mode
				document.addEventListener('DOMContentLoaded', function() {
					var content = @templ.Raw(getArticleContentJS(article.Content));
					if (content) {
						quill.root.innerHTML = content;
					}
				});
			</script>
		}
	}
}

// Helper function to escape content for JavaScript
func getArticleContentJS(content string) string {
	// This returns a JSON-encoded string that's safe for JS
	return fmt.Sprintf("%q", content)
}

func getArticleFormTitle(isEdit bool) string {
	if isEdit {
		return "Editar Artículo"
	}
	return "Nuevo Artículo"
}

// adminSidebarContent renders the sidebar content for the drawer
templ adminSidebarContent() {
	<div class="drawer-side">
		<label for="admin-drawer" class="drawer-overlay"></label>
		<aside class="bg-base-100 w-64 min-h-screen">
			<div class="p-4">
				<h2 class="text-2xl font-bold text-primary">JR del Perú</h2>
				<p class="text-sm text-base-content/70">Administración</p>
			</div>
			<ul class="menu p-4 w-full">
				<li class="menu-title">
					<span>Principal</span>
				</li>
				<li>
					<a href="/admin/dashboard" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
						</svg>
						Dashboard
					</a>
				</li>
				<li class="menu-title">
					<span>Contenido</span>
				</li>
				<li>
					<a href="/admin/categories" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
						</svg>
						Categorías
					</a>
				</li>
				<li>
					<a href="/admin/tags" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
						</svg>
						Etiquetas
					</a>
				</li>
				<li>
					<a href="/admin/projects" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
						</svg>
						Proyectos
					</a>
				</li>
				<li>
					<a href="/admin/files" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
						</svg>
						Archivos
					</a>
				</li>
				<li>
					<a href="/admin/documents" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
						</svg>
						Documentos
					</a>
				</li>
				<li class="menu-title">
					<span>Blog</span>
				</li>
				<li>
					<a href="/admin/articles" class="hover:bg-primary hover:text-primary-content bg-primary text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
						</svg>
						Artículos
					</a>
				</li>
				<li>
					<a href="/admin/faqs" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
						Preguntas Frecuentes
					</a>
				</li>
				<li class="menu-title">
					<span>Comunicación</span>
				</li>
				<li>
					<a href="/admin/contact" class="hover:bg-primary hover:text-primary-content">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
						</svg>
						Mensajes
					</a>
				</li>
			</ul>
		</aside>
	</div>
}

// AdminArticleDetailPage muestra el detalle del artículo con gestión de FAQs
templ AdminArticleDetailPage(username string, article repository.GetArticleRow, faqs []repository.ArticleFaq, coverImage *repository.StaticFile) {
	@AdminLayout("Detalle del Artículo", username) {
		<div class="space-y-6">
			<div class="flex items-center gap-4">
				<a href="/admin/articles" class="btn btn-ghost btn-sm">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
					</svg>
				</a>
				<h1 class="text-3xl font-bold">{ article.Title }</h1>
				if article.IsPublished {
					<span class="badge badge-success">Publicado</span>
				} else {
					<span class="badge badge-warning">Borrador</span>
				}
			</div>
			<!-- Article Info Card -->
			<div class="card bg-base-100 shadow-xl">
				<div class="card-body">
					<div class="flex justify-between items-start flex-wrap gap-4">
						<h2 class="card-title text-2xl">Información del Artículo</h2>
						<div class="flex gap-2">
							if article.IsPublished {
								<button
									hx-post={ fmt.Sprintf("/admin/articles/%d/unpublish", article.ArticleID) }
									hx-confirm="¿Despublicar este artículo?"
									hx-target="body"
									class="btn btn-ghost btn-sm"
								>
									Despublicar
								</button>
							} else {
								<button
									hx-post={ fmt.Sprintf("/admin/articles/%d/publish", article.ArticleID) }
									hx-confirm="¿Publicar este artículo?"
									hx-target="body"
									class="btn btn-success btn-sm"
								>
									Publicar
								</button>
							}
							<a href={ templ.URL(fmt.Sprintf("/admin/articles/%d/edit", article.ArticleID)) } class="btn btn-warning btn-sm">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
								</svg>
								Editar
							</a>
						</div>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
						<!-- Cover Image -->
						<div class="md:col-span-1">
							<span class="font-semibold text-base-content/70">Imagen de Portada:</span>
							<div class="mt-2">
								if coverImage != nil {
									<img src={ path.Join(config.IMAGES_PATH, coverImage.FileName) } alt={ article.Title } class="rounded-lg w-full aspect-video object-cover"/>
								} else {
									<div class="bg-base-300 rounded-lg w-full aspect-video flex items-center justify-center">
										<span class="text-base-content/50">Sin imagen</span>
									</div>
								}
							</div>
						</div>
						<!-- Details -->
						<div class="md:col-span-2 space-y-4">
							<div>
								<span class="font-semibold text-base-content/70">Slug:</span>
								<p class="font-mono text-sm">{ article.Slug }</p>
							</div>
							<div>
								<span class="font-semibold text-base-content/70">Autor:</span>
								<p>{ article.Author }</p>
							</div>
							<div>
								<span class="font-semibold text-base-content/70">Resumen (SEO):</span>
								<p class="mt-1 text-base-content/80">{ article.Summary }</p>
							</div>
							<div class="flex gap-8">
								<div>
									<span class="font-semibold text-base-content/70">Creado:</span>
									<p>{ formatCreatedAtDetail(article) }</p>
								</div>
								if article.IsPublished {
									<div>
										<span class="font-semibold text-base-content/70">Publicado:</span>
										<p>{ formatPublishedAtDetail(article) }</p>
									</div>
								}
							</div>
						</div>
					</div>
					<!-- Content Preview -->
					<div class="mt-6">
						<span class="font-semibold text-base-content/70">Contenido:</span>
						<div class="mt-2 p-4 bg-base-200 rounded-lg prose max-w-none">
							@templ.Raw(article.Content)
						</div>
					</div>
				</div>
			</div>
			<!-- FAQs Management -->
			<div class="card bg-base-100 shadow-xl">
				<div class="card-body">
					<h2 class="card-title text-2xl">Preguntas Frecuentes del Artículo</h2>
					<p class="text-base-content/70">Agrega preguntas y respuestas relacionadas con este artículo.</p>
					<!-- Add FAQ Form -->
					<div class="border-2 border-dashed border-base-300 rounded-lg p-6 mt-4">
						<h3 class="font-semibold mb-4">Agregar Nueva Pregunta</h3>
						<form
							hx-post={ fmt.Sprintf("/admin/articles/%d/faqs", article.ArticleID) }
							hx-target="#article-faqs-grid"
							hx-swap="innerHTML"
							hx-on::after-request="this.reset()"
							class="space-y-4"
						>
							<div class="form-control">
								<label class="label">
									<span class="label-text font-semibold">Pregunta *</span>
								</label>
								<input
									type="text"
									name="question"
									class="input input-bordered"
									placeholder="¿Cuál es la pregunta?"
									required
								/>
							</div>
							<div class="form-control">
								<label class="label">
									<span class="label-text font-semibold">Respuesta *</span>
								</label>
								<textarea
									name="answer"
									class="textarea textarea-bordered"
									rows="3"
									placeholder="La respuesta a la pregunta..."
									required
								></textarea>
							</div>
							<div class="flex gap-4 items-end">
								<div class="form-control w-32">
									<label class="label">
										<span class="label-text">Orden</span>
									</label>
									<input type="number" name="display_order" class="input input-bordered" value="0" min="0"/>
								</div>
								<button type="submit" class="btn btn-primary">Agregar Pregunta</button>
							</div>
						</form>
					</div>
					<!-- FAQs List -->
					<div id="article-faqs-grid" class="space-y-4 mt-6">
						@AdminArticleFAQsGrid(article.ArticleID, faqs)
					</div>
				</div>
			</div>
		</div>
	}
}

// AdminArticleFAQsGrid renderiza la lista de FAQs del artículo
templ AdminArticleFAQsGrid(articleID int32, faqs []repository.ArticleFaq) {
	if len(faqs) == 0 {
		<div class="text-center text-base-content/60 py-8">
			No hay preguntas frecuentes para este artículo.
		</div>
	} else {
		for _, faq := range faqs {
			@AdminArticleFAQCard(articleID, faq)
		}
	}
}

// AdminArticleFAQCard representa una tarjeta de FAQ
templ AdminArticleFAQCard(articleID int32, faq repository.ArticleFaq) {
	<div class="card bg-base-200" id={ fmt.Sprintf("faq-%d", faq.FaqID) }>
		<div class="card-body">
			<form
				hx-put={ fmt.Sprintf("/admin/articles/%d/faqs/%d", articleID, faq.FaqID) }
				hx-target="#article-faqs-grid"
				hx-swap="innerHTML"
				class="space-y-4"
			>
				<div class="flex gap-4 items-start">
					<div class="flex-1 space-y-4">
						<div class="form-control">
							<label class="label">
								<span class="label-text font-semibold">Pregunta</span>
							</label>
							<input
								type="text"
								name="question"
								class="input input-bordered"
								value={ faq.Question }
								required
							/>
						</div>
						<div class="form-control">
							<label class="label">
								<span class="label-text font-semibold">Respuesta</span>
							</label>
							<textarea
								name="answer"
								class="textarea textarea-bordered"
								rows="2"
								required
							>{ faq.Answer }</textarea>
						</div>
					</div>
					<div class="flex flex-col gap-2">
						<div class="form-control">
							<label class="label">
								<span class="label-text text-xs">Orden</span>
							</label>
							<input
								type="number"
								name="display_order"
								class="input input-bordered input-sm w-20"
								value={ fmt.Sprint(faq.DisplayOrder) }
								min="0"
							/>
						</div>
					</div>
				</div>
				<div class="flex gap-2 justify-end">
					<button type="submit" class="btn btn-sm btn-primary">Guardar</button>
					<button
						type="button"
						hx-delete={ fmt.Sprintf("/admin/articles/%d/faqs/%d", articleID, faq.FaqID) }
						hx-confirm="¿Eliminar esta pregunta?"
						hx-target="#article-faqs-grid"
						hx-swap="innerHTML"
						class="btn btn-sm btn-error"
					>
						Eliminar
					</button>
				</div>
			</form>
		</div>
	</div>
}
